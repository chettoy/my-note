(this["webpackJsonpmy-note"]=this["webpackJsonpmy-note"]||[]).push([[4],{101:function(t,e,n){"use strict";n.r(e);var s=n(1),i=n(2),a=n(4),o=n(7),r=n(6),u=n(10),l=n(0),c=n.n(l),d=n(54),p=n(34),y=u.b.div.withConfig({displayName:"MusicPlayer__PlayerView",componentId:"i0rlf3-0"})(["width:100%;padding:0.5rem;box-sizing:border-box;font-family:'Source Sans Pro','Courier New','Courier',monospace;"]),g=function(t){Object(o.a)(n,t);var e=Object(r.a)(n);function n(t){var s;if(Object(i.a)(this,n),(s=e.call(this,t)).audio=new Audio,s.status=null,s.textSpace=10,s.playlist=[],s.playingIndex=0,s.waittingForPlay=!1,s.recoveryProgressHandled=!1,s._DEBUG=!1,s.playerEvents={error:function(){s.status.textContent="bgm: error "+s.audio.error.code},canplay:function(){s.waittingForPlay&&s.callPlay()},play:function(){s.waittingForPlay=!1,s.status.textContent="bgm: play"},playing:function(){s.status.textContent="#",s.recoveryProgressHandled||s.recoveryProgress();var t=setInterval((function(){"#"===s.status.textContent.substr(0,1)?(s.status.textContent=s.getProgressText(),s.saveProgressInfo()):clearInterval(t)}),300)},progress:function(){!s.isAnimating()&&s.audio.readyState<4&&s.showAnimating()},pause:function(){s.status.textContent="bgm: pause"},waiting:function(){s.isAnimating()||s.showAnimating()},ended:function(){s.status.textContent="bgm: ended",s.saveProgressInfo(),s.playNext()}},s.getTextSpace=function(){var t=document.createElement("span");t.style.visibility="hidden",s.status.parentNode.appendChild(t);var e=getComputedStyle(s.status.parentNode);for(t.textContent="#";s.status.parentNode.offsetWidth-(parseFloat(e.paddingLeft)+parseFloat(e.paddingRight))>t.getBoundingClientRect().width;t.textContent+="#");s.textSpace=t.textContent.length-1,s.status.parentNode.removeChild(t)},s.handleClick=function(){s.audio.paused||0===s.audio.currentTime?(window.sessionStorage&&(sessionStorage.music_paused=null),s.audio.src?s.callPlay():s.playByIndex(0)):(window.sessionStorage&&(sessionStorage.music_paused="paused"),s.audio.pause())},s._DEBUG){var a=function(t){s.playerEvents["_"+t]=s.playerEvents[t],s.playerEvents[t]=function(){console.log("bgm: event[".concat(t,"]")),s.playerEvents["_"+t]()}};for(var o in s.playerEvents)a(o)}return s}return Object(a.a)(n,[{key:"loadPlaylist",value:function(){var t=this;return new Promise((function(e,n){fetch("/my-note/playlist.json").then((function(t){return t.json()})).then((function(n){var s=n.result.tracks;for(var i in s)t.playlist.push(s[i].id);e(n)}),(function(t){p.a.log(t),n(t)}))}))}},{key:"playByIndex",value:function(t){if(t>=this.playlist.length||t<0)p.a.log("Playlist[".concat(t,"] not exists. "));else{this.playingIndex=t;var e="https://music.163.com/song/media/outer/url?id="+this.playlist[t]+".mp3";this.audio.src=e,window.sessionStorage&&(sessionStorage.music_playingIndex=t),this.waittingForPlay=!0}}},{key:"playNext",value:function(){var t=parseInt(this.playingIndex)+1;t<this.playlist.length?this.playByIndex(t):this.playByIndex(0)}},{key:"saveProgressInfo",value:function(){window.sessionStorage&&(this.audio.ended?sessionStorage.music_currentTime=0:sessionStorage.music_currentTime=this.audio.currentTime)}},{key:"recoveryProgress",value:function(){this.recoveryProgressHandled=!0,window.sessionStorage&&(sessionStorage.music_currentTime&&(this.audio.currentTime=sessionStorage.music_currentTime),"paused"===sessionStorage.music_paused&&this.audio.pause())}},{key:"getProgressText",value:function(){var t,e=this.textSpace,n=Math.round(this.audio.currentTime/this.audio.duration*e);for(t="#";t.length<n;t+="#");for(;t.length<e;t+="=");return t}},{key:"isAnimating",value:function(){return">"===this.status.textContent.substr(0,1)}},{key:"showAnimating",value:function(){var t=this;this.status.textContent=">";var e=setInterval((function(){t.isAnimating()?(t.status.textContent.length>=t.textSpace&&(t.status.textContent=""),t.status.textContent+=">"):clearInterval(e)}),200)}},{key:"callPlay",value:function(){var t=this.audio.play();void 0!==t&&t.then((function(t){p.a.log("bgm","play started")})).catch((function(t){"NotAllowedError"!==t.name&&p.a.log("bgm","play interruped: "+t)}))}},{key:"render",value:function(){var t=this;return Object(s.jsx)(y,{children:Object(s.jsx)("span",{className:"status",ref:function(e){return t.status=e},onClick:this.handleClick,children:"music.."})})}},{key:"componentDidMount",value:function(){var t=this;for(var e in this.getTextSpace(),window.addEventListener("resize",this.getTextSpace),this.playerEvents)this.audio.addEventListener(e,this.playerEvents[e]);this.loadPlaylist().then((function(){console.log("bgm","playlist loaded"),console.log(t.playlist),window.sessionStorage&&sessionStorage.music_playingIndex?t.playByIndex(sessionStorage.music_playingIndex):d.a.autoplay&&t.playByIndex(0)}))}},{key:"componentWillUnmount",value:function(){for(var t in window.removeEventListener("resize",this.getTextSpace),this.playerEvents)this.audio.removeEventListener(t,this.playerEvents[t])}}]),n}(c.a.Component);e.default=g}}]);
//# sourceMappingURL=4.8a049eaa.chunk.js.map
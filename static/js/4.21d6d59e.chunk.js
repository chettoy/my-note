(this["webpackJsonpmy-note"]=this["webpackJsonpmy-note"]||[]).push([[4],{98:function(t,e,n){"use strict";n.r(e);var s=n(2),i=n(3),a=n(6),o=n(5),r=n(9),u=n(0),l=n.n(u),c=n(51),d=n(35),p=n(1),y=r.b.div.withConfig({displayName:"MusicPlayer__PlayerView",componentId:"i0rlf3-0"})(["width:100%;padding:0.5rem;box-sizing:border-box;font-family:'Source Sans Pro','Courier New','Courier',monospace;"]),g=function(t){Object(a.a)(n,t);var e=Object(o.a)(n);function n(t){var i;if(Object(s.a)(this,n),(i=e.call(this,t)).audio=new Audio,i.status=null,i.textSpace=10,i.playlist=[],i.playingIndex=0,i.waittingForPlay=!1,i.recoveryProgressHandled=!1,i._DEBUG=!1,i.playerEvents={error:function(){i.status.textContent="bgm: error "+i.audio.error.code},canplay:function(){i.waittingForPlay&&i.callPlay()},play:function(){i.waittingForPlay=!1,i.status.textContent="bgm: play"},playing:function(){i.status.textContent="#",i.recoveryProgressHandled||i.recoveryProgress();var t=setInterval((function(){"#"===i.status.textContent.substr(0,1)?(i.status.textContent=i.getProgressText(),i.saveProgressInfo()):clearInterval(t)}),300)},progress:function(){!i.isAnimating()&&i.audio.readyState<4&&i.showAnimating()},pause:function(){i.status.textContent="bgm: pause"},waiting:function(){i.isAnimating()||i.showAnimating()},ended:function(){i.status.textContent="bgm: ended",i.saveProgressInfo(),i.playNext()}},i.getTextSpace=function(){var t=document.createElement("span");t.style.visibility="hidden",i.status.parentNode.appendChild(t);var e=getComputedStyle(i.status.parentNode);for(t.textContent="#";i.status.parentNode.offsetWidth-(parseFloat(e.paddingLeft)+parseFloat(e.paddingRight))>t.getBoundingClientRect().width;t.textContent+="#");i.textSpace=t.textContent.length-1,i.status.parentNode.removeChild(t)},i.handleClick=function(){i.audio.paused||0===i.audio.currentTime?(window.sessionStorage&&(sessionStorage.music_paused=null),i.audio.src?i.callPlay():i.playByIndex(0)):(window.sessionStorage&&(sessionStorage.music_paused="paused"),i.audio.pause())},i._DEBUG){var a=function(t){i.playerEvents["_"+t]=i.playerEvents[t],i.playerEvents[t]=function(){console.log("bgm: event[".concat(t,"]")),i.playerEvents["_"+t]()}};for(var o in i.playerEvents)a(o)}return i}return Object(i.a)(n,[{key:"loadPlaylist",value:function(){var t=this;return new Promise((function(e,n){fetch("/my-note/playlist.json").then((function(t){return t.json()})).then((function(n){var s=n.result.tracks;for(var i in s)t.playlist.push(s[i].id);e(n)}),(function(t){d.a.log(t),n(t)}))}))}},{key:"playByIndex",value:function(t){if(t>=this.playlist.length||t<0)d.a.log("Playlist[".concat(t,"] not exists. "));else{this.playingIndex=t;var e="https://music.163.com/song/media/outer/url?id="+this.playlist[t]+".mp3";this.audio.src=e,window.sessionStorage&&(sessionStorage.music_playingIndex=t),this.waittingForPlay=!0}}},{key:"playNext",value:function(){var t=parseInt(this.playingIndex)+1;t<this.playlist.length?this.playByIndex(t):this.playByIndex(0)}},{key:"saveProgressInfo",value:function(){window.sessionStorage&&(this.audio.ended?sessionStorage.music_currentTime=0:sessionStorage.music_currentTime=this.audio.currentTime)}},{key:"recoveryProgress",value:function(){this.recoveryProgressHandled=!0,window.sessionStorage&&(sessionStorage.music_currentTime&&(this.audio.currentTime=sessionStorage.music_currentTime),"paused"===sessionStorage.music_paused&&this.audio.pause())}},{key:"getProgressText",value:function(){var t,e=this.textSpace,n=Math.round(this.audio.currentTime/this.audio.duration*e);for(t="#";t.length<n;t+="#");for(;t.length<e;t+="=");return t}},{key:"isAnimating",value:function(){return">"===this.status.textContent.substr(0,1)}},{key:"showAnimating",value:function(){var t=this;this.status.textContent=">";var e=setInterval((function(){t.isAnimating()?(t.status.textContent.length>=t.textSpace&&(t.status.textContent=""),t.status.textContent+=">"):clearInterval(e)}),200)}},{key:"callPlay",value:function(){var t=this.audio.play();void 0!==t&&t.then((function(t){d.a.log("bgm","play started")})).catch((function(t){"NotAllowedError"!==t.name&&d.a.log("bgm","play interruped: "+t)}))}},{key:"render",value:function(){var t=this;return Object(p.jsx)(y,{children:Object(p.jsx)("span",{className:"status",ref:function(e){return t.status=e},onClick:this.handleClick,children:"music.."})})}},{key:"componentDidMount",value:function(){var t=this;for(var e in this.getTextSpace(),window.addEventListener("resize",this.getTextSpace),this.playerEvents)this.audio.addEventListener(e,this.playerEvents[e]);this.loadPlaylist().then((function(){console.log("bgm","playlist loaded"),console.log(t.playlist),window.sessionStorage&&sessionStorage.music_playingIndex?t.playByIndex(sessionStorage.music_playingIndex):c.a.autoplay&&t.playByIndex(0)}))}},{key:"componentWillUnmount",value:function(){for(var t in window.removeEventListener("resize",this.getTextSpace),this.playerEvents)this.audio.removeEventListener(t,this.playerEvents[t])}}]),n}(l.a.Component);e.default=g}}]);
//# sourceMappingURL=4.21d6d59e.chunk.js.map
(this["webpackJsonpmy-note"]=this["webpackJsonpmy-note"]||[]).push([[5],{727:function(t,e,n){"use strict";n.r(e);var s=n(3),a=n(4),i=n(7),o=n(6),r=n(12),u=n(0),l=n.n(u),c=n(62),d=n(45),p=n(1),y=r.default.div.withConfig({displayName:"MusicPlayer__PlayerView",componentId:"sc-i0rlf3-0"})(["width:100%;padding:0.5rem;box-sizing:border-box;font-family:'Source Sans Pro','Courier New','Courier',monospace;"]),g=function(t){Object(i.a)(n,t);var e=Object(o.a)(n);function n(t){var a;if(Object(s.a)(this,n),(a=e.call(this,t)).audio=new Audio,a.status=null,a.textSpace=10,a.playlist=[],a.playingIndex=0,a.waittingForPlay=!1,a.recoveryProgressHandled=!1,a._DEBUG=!1,a.playerEvents={error:function(){a.status.textContent="bgm: error "+a.audio.error.code},canplay:function(){a.waittingForPlay&&a.callPlay()},play:function(){a.waittingForPlay=!1,a.status.textContent="bgm: play"},playing:function(){a.status.textContent="#",a.recoveryProgressHandled||a.recoveryProgress();var t=setInterval((function(){"#"===a.status.textContent.substr(0,1)?(a.status.textContent=a.getProgressText(),a.saveProgressInfo()):clearInterval(t)}),300)},progress:function(){!a.isAnimating()&&a.audio.readyState<4&&a.showAnimating()},pause:function(){a.status.textContent="bgm: pause"},waiting:function(){a.isAnimating()||a.showAnimating()},ended:function(){a.status.textContent="bgm: ended",a.saveProgressInfo(),a.playNext()}},a.getTextSpace=function(){var t=document.createElement("span");t.style.visibility="hidden",a.status.parentNode.appendChild(t);var e=getComputedStyle(a.status.parentNode);for(t.textContent="#";a.status.parentNode.offsetWidth-(parseFloat(e.paddingLeft)+parseFloat(e.paddingRight))>t.getBoundingClientRect().width;t.textContent+="#");a.textSpace=t.textContent.length-1,a.status.parentNode.removeChild(t)},a.handleClick=function(){a.audio.paused||0===a.audio.currentTime?(window.sessionStorage&&(sessionStorage.music_paused=null),a.audio.src?a.callPlay():a.playByIndex(0)):(window.sessionStorage&&(sessionStorage.music_paused="paused"),a.audio.pause())},a._DEBUG){var i=function(t){a.playerEvents["_"+t]=a.playerEvents[t],a.playerEvents[t]=function(){console.log("bgm: event[".concat(t,"]")),a.playerEvents["_"+t]()}};for(var o in a.playerEvents)i(o)}return a}return Object(a.a)(n,[{key:"loadPlaylist",value:function(){var t=this;return new Promise((function(e,n){fetch("/my-note/playlist.json").then((function(t){return t.json()})).then((function(n){var s=n.result.tracks;for(var a in s)t.playlist.push(s[a].id);e(n)}),(function(t){d.a.log(t),n(t)}))}))}},{key:"playByIndex",value:function(t){if(t>=this.playlist.length||t<0)d.a.log("Playlist[".concat(t,"] not exists. "));else{this.playingIndex=t;var e="https://music.163.com/song/media/outer/url?id="+this.playlist[t]+".mp3";this.audio.src=e,window.sessionStorage&&(sessionStorage.music_playingIndex=t),this.waittingForPlay=!0}}},{key:"playNext",value:function(){var t=parseInt(this.playingIndex)+1;t<this.playlist.length?this.playByIndex(t):this.playByIndex(0)}},{key:"saveProgressInfo",value:function(){window.sessionStorage&&(this.audio.ended?sessionStorage.music_currentTime=0:sessionStorage.music_currentTime=this.audio.currentTime)}},{key:"recoveryProgress",value:function(){this.recoveryProgressHandled=!0,window.sessionStorage&&(sessionStorage.music_currentTime&&(this.audio.currentTime=sessionStorage.music_currentTime),"paused"===sessionStorage.music_paused&&this.audio.pause())}},{key:"getProgressText",value:function(){var t,e=this.textSpace,n=Math.round(this.audio.currentTime/this.audio.duration*e);for(t="#";t.length<n;t+="#");for(;t.length<e;t+="=");return t}},{key:"isAnimating",value:function(){return">"===this.status.textContent.substr(0,1)}},{key:"showAnimating",value:function(){var t=this;this.status.textContent=">";var e=setInterval((function(){t.isAnimating()?(t.status.textContent.length>=t.textSpace&&(t.status.textContent=""),t.status.textContent+=">"):clearInterval(e)}),200)}},{key:"callPlay",value:function(){var t=this.audio.play();void 0!==t&&t.then((function(t){d.a.log("bgm","play started")})).catch((function(t){"NotAllowedError"!==t.name&&d.a.log("bgm","play interruped: "+t)}))}},{key:"render",value:function(){var t=this;return Object(p.jsx)(y,{children:Object(p.jsx)("span",{className:"status",ref:function(e){return t.status=e},onClick:this.handleClick,children:"music.."})})}},{key:"componentDidMount",value:function(){var t=this;for(var e in this.getTextSpace(),window.addEventListener("resize",this.getTextSpace),this.playerEvents)this.audio.addEventListener(e,this.playerEvents[e]);this.loadPlaylist().then((function(){console.log("bgm","playlist loaded"),console.log(t.playlist),window.sessionStorage&&sessionStorage.music_playingIndex?t.playByIndex(sessionStorage.music_playingIndex):c.a.autoplay&&t.playByIndex(0)}))}},{key:"componentWillUnmount",value:function(){for(var t in window.removeEventListener("resize",this.getTextSpace),this.playerEvents)this.audio.removeEventListener(t,this.playerEvents[t])}}]),n}(l.a.Component);e.default=g}}]);
//# sourceMappingURL=5.349a93f0.chunk.js.map
(this["webpackJsonpmy-note"]=this["webpackJsonpmy-note"]||[]).push([[5],{686:function(t,s,e){"use strict";e.r(s);var i,n=e(10),a=e(7),o=e(0),r=e.n(o),l=e(51),h=e(35),d=e(1);const u=a.default.div(i||(i=Object(n.a)(["\n  width: 100%;\n  padding: 0.5rem;\n  box-sizing: border-box;\n  font-family: 'Source Sans Pro', 'Courier New', 'Courier', monospace;\n"])));class c extends r.a.Component{constructor(t){if(super(t),this.audio=new Audio,this.status=null,this.textSpace=10,this.playlist=[],this.playingIndex=0,this.waittingForPlay=!1,this.recoveryProgressHandled=!1,this._DEBUG=!1,this.playerEvents={error:()=>{this.status.textContent="bgm: error "+this.audio.error.code},canplay:()=>{this.waittingForPlay&&this.callPlay()},play:()=>{this.waittingForPlay=!1,this.status.textContent="bgm: play"},playing:()=>{this.status.textContent="#",this.recoveryProgressHandled||this.recoveryProgress();const t=setInterval((()=>{"#"===this.status.textContent.substr(0,1)?(this.status.textContent=this.getProgressText(),this.saveProgressInfo()):clearInterval(t)}),300)},progress:()=>{!this.isAnimating()&&this.audio.readyState<4&&this.showAnimating()},pause:()=>{this.status.textContent="bgm: pause"},waiting:()=>{this.isAnimating()||this.showAnimating()},ended:()=>{this.status.textContent="bgm: ended",this.saveProgressInfo(),this.playNext()}},this.getTextSpace=()=>{const t=document.createElement("span");t.style.visibility="hidden",this.status.parentNode.appendChild(t);const s=getComputedStyle(this.status.parentNode);for(t.textContent="#";this.status.parentNode.offsetWidth-(parseFloat(s.paddingLeft)+parseFloat(s.paddingRight))>t.getBoundingClientRect().width;t.textContent+="#");this.textSpace=t.textContent.length-1,this.status.parentNode.removeChild(t)},this.handleClick=()=>{this.audio.paused||0===this.audio.currentTime?(window.sessionStorage&&(sessionStorage.music_paused=null),this.audio.src?this.callPlay():this.playByIndex(0)):(window.sessionStorage&&(sessionStorage.music_paused="paused"),this.audio.pause())},this._DEBUG)for(const s in this.playerEvents)this.playerEvents["_"+s]=this.playerEvents[s],this.playerEvents[s]=()=>{console.log("bgm: event[".concat(s,"]")),this.playerEvents["_"+s]()}}loadPlaylist(){return new Promise(((t,s)=>{fetch("/my-note/playlist.json").then((t=>t.json())).then((s=>{const e=s.result.tracks;for(const t in e)this.playlist.push(e[t].id);t(s)}),(t=>{h.a.log(t),s(t)}))}))}playByIndex(t){if(t>=this.playlist.length||t<0)return void h.a.log("Playlist[".concat(t,"] not exists. "));this.playingIndex=t;const s="https://music.163.com/song/media/outer/url?id="+this.playlist[t]+".mp3";this.audio.src=s,window.sessionStorage&&(sessionStorage.music_playingIndex=t),this.waittingForPlay=!0}playNext(){const t=parseInt(this.playingIndex)+1;t<this.playlist.length?this.playByIndex(t):this.playByIndex(0)}saveProgressInfo(){window.sessionStorage&&(this.audio.ended?sessionStorage.music_currentTime=0:sessionStorage.music_currentTime=this.audio.currentTime)}recoveryProgress(){this.recoveryProgressHandled=!0,window.sessionStorage&&(sessionStorage.music_currentTime&&(this.audio.currentTime=sessionStorage.music_currentTime),"paused"===sessionStorage.music_paused&&this.audio.pause())}getProgressText(){const t=this.textSpace,s=Math.round(this.audio.currentTime/this.audio.duration*t);let e;for(e="#";e.length<s;e+="#");for(;e.length<t;e+="=");return e}isAnimating(){return">"===this.status.textContent.substr(0,1)}showAnimating(){this.status.textContent=">";const t=setInterval((()=>{this.isAnimating()?(this.status.textContent.length>=this.textSpace&&(this.status.textContent=""),this.status.textContent+=">"):clearInterval(t)}),200)}callPlay(){const t=this.audio.play();void 0!==t&&t.then((t=>{h.a.log("bgm","play started")})).catch((t=>{"NotAllowedError"!==t.name&&h.a.log("bgm","play interruped: "+t)}))}render(){return Object(d.jsx)(u,{children:Object(d.jsx)("span",{className:"status",ref:t=>this.status=t,onClick:this.handleClick,children:"music.."})})}componentDidMount(){this.getTextSpace(),window.addEventListener("resize",this.getTextSpace);for(const t in this.playerEvents)this.audio.addEventListener(t,this.playerEvents[t]);this.loadPlaylist().then((()=>{console.log("bgm","playlist loaded"),console.log(this.playlist),window.sessionStorage&&sessionStorage.music_playingIndex?this.playByIndex(sessionStorage.music_playingIndex):l.a.autoplay&&this.playByIndex(0)}))}componentWillUnmount(){window.removeEventListener("resize",this.getTextSpace);for(const t in this.playerEvents)this.audio.removeEventListener(t,this.playerEvents[t])}}s.default=c}}]);
//# sourceMappingURL=5.f21cb2ef.chunk.js.map